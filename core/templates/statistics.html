<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Статистика - Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

{% include 'navbar.html' %}

<div class="container-fluid px-4">
    <h3 class="mb-4"><i class="bi bi-graph-up"></i> Статистика</h3>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if role == 'Lead' %}

    {% if team_stats %}
    <div class="row mb-5">
        <div class="col-12">
            <h5 class="mb-3">Статистика команд</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover bg-white shadow-sm">
                    <thead class="table-dark">
                    <tr>
                        <th>Команда</th>
                        <th>Учасників</th>
                        <th>Проектів</th>
                        <th>Завдань</th>
                        <th>Виконано</th>
                        <th>Активних</th>
                        <th>Прогрес</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for stat in team_stats %}
                    <tr>
                        <td><strong>{{ stat.team.title }}</strong></td>
                        <td>{{ stat.members_count }}</td>
                        <td>{{ stat.projects_count }}</td>
                        <td>{{ stat.tasks_total }}</td>
                        <td><span class="badge bg-success">{{ stat.tasks_done }}</span></td>
                        <td><span class="badge bg-info">{{ stat.tasks_active }}</span></td>
                        <td style="min-width: 150px;">
                            {% with total=stat.tasks_total|default:0|add:0 done=stat.tasks_done|default:0|add:0 %}
                            <div class="progress" style="height: 20px;">
                                {% if total > 0 %}
                                {% widthratio done total 100 as progress %}
                                {% if progress|add:"0" > 0 %}
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: {{ progress }}%;"
                                     aria-valuenow="{{ progress }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ progress }}%
                                </div>
                                {% else %}
                                <div class="progress-bar bg-transparent text-dark w-100" role="progressbar">
                                    0%
                                </div>
                                {% endif %}
                                {% else %}
                                <div class="progress-bar bg-transparent text-dark w-100" role="progressbar">
                                    0%
                                </div>
                                {% endif %}
                            </div>
                            {% endwith %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if worker_stats %}
    <div class="row mb-5">
        <div class="col-12">
            <h5 class="mb-3">Статистика працівників</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover bg-white shadow-sm">
                    <thead class="table-dark">
                    <tr>
                        <th>Працівник</th>
                        <th>Роль</th>
                        <th>Завдань</th>
                        <th>Виконано</th>
                        <th>Підзавдань</th>
                        <th>Виконано підзавдань</th>
                        <th>Ефективність</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for stat in worker_stats %}
                    <tr>
                        <td><strong>{{ stat.worker.name }} {{ stat.worker.surname }}</strong></td>
                        <td><span class="badge bg-secondary">{{ stat.worker.role }}</span></td>
                        <td>{{ stat.tasks_total|default:0 }}</td>
                        <td><span class="badge bg-success">{{ stat.tasks_done|default:0 }}</span></td>
                        <td>{{ stat.undertasks_total|default:0 }}</td>
                        <td><span class="badge bg-success">{{ stat.undertasks_done|default:0 }}</span></td>
                        <td style="min-width: 150px;">
                            {% with total=stat.tasks_total|default:0|add:0 done=stat.tasks_done|default:0|add:0 %}
                            <div class="progress" style="height: 20px;">
                                {% if total > 0 %}
                                {% widthratio done total 100 as efficiency %}
                                {% if efficiency|add:"0" > 0 %}
                                <div class="progress-bar bg-primary"
                                     role="progressbar"
                                     style="width: {{ efficiency }}%;"
                                     aria-valuenow="{{ efficiency }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ efficiency }}%
                                </div>
                                {% else %}
                                <div class="progress-bar bg-transparent text-dark w-100" role="progressbar">
                                    0%
                                </div>
                                {% endif %}
                                {% else %}
                                <div class="progress-bar bg-transparent text-dark w-100" role="progressbar">
                                    0%
                                </div>
                                {% endif %}
                            </div>
                            {% endwith %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% elif role == 'Individual' %}

    {% if my_stats %}
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white mb-3">
                <div class="card-body">
                    <h2>{{ my_stats.total_tasks }}</h2>
                    <p>Всього завдань</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white mb-3">
                <div class="card-body">
                    <h2>{{ my_stats.done_tasks }}</h2>
                    <p>Виконано</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white mb-3">
                <div class="card-body">
                    <h2>{{ my_stats.active_tasks }}</h2>
                    <p>Активних</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark mb-3">
                <div class="card-body">
                    <h2>{{ my_stats.canceled_tasks }}</h2>
                    <p>Скасовано</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Статистика доступна тільки для ролей Lead та Individual
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Назад до Dashboard
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>